<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>–î–æ–º –¥–≤–µ—Ä–µ–π –∏ –ª–∞–º–∏–Ω–∞—Ç–∞</title>

  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root {
      --tg-bg: #ffffff;
      --tg-text: #000000;
      --tg-hint: #999999;
      --tg-button: #0088cc;
      --tg-button-text: #ffffff;
      --tg-secondary-bg: #f5f5f5;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: var(--tg-bg);
      color: var(--tg-text);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      padding: 12px;
      font-size: 15px;
    }

    #app {
      max-width: 100%;
    }

    .logo {
      width: 100%;
      text-align: center;
      margin-bottom: 20px;
    }

    .logo img {
      max-width: 120px;
      height: auto;
    }

    .section {
      background: var(--tg-secondary-bg);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
    }

    .section-title {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 12px;
      color: var(--tg-text);
    }

    .form-group {
      margin-bottom: 12px;
    }

    label {
      display: block;
      font-size: 12px;
      color: var(--tg-hint);
      margin-bottom: 4px;
      font-weight: 500;
    }

    input,
    select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--tg-secondary-bg);
      border-radius: 6px;
      font-size: 14px;
      background: var(--tg-bg);
      color: var(--tg-text);
      font-family: inherit;
    }

    input:focus,
    select:focus {
      outline: none;
      border-color: var(--tg-button);
      box-shadow: 0 0 0 2px rgba(0, 136, 204, 0.1);
    }

    .btn {
      padding: 12px 16px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      width: 100%;
      margin-bottom: 10px;
    }

    .btn-primary {
      background: var(--tg-button);
      color: var(--tg-button-text);
    }

    .btn-primary:active {
      opacity: 0.8;
    }

    .btn-group {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }

    .btn-group .btn {
      flex: 1;
      margin: 0;
      border: 2px solid var(--tg-button);
      background: transparent;
      color: var(--tg-button);
    }

    .btn-group .btn.active {
      background: var(--tg-button);
      color: var(--tg-button-text);
    }



    .btn-mini {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: none;
      background: var(--tg-button);
      color: var(--tg-button-text);
      font-size: 18px;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      -webkit-tap-highlight-color: transparent;
    }

    .btn-mini.toggle {
      width: auto;
      background: var(--tg-bg);
      color: var(--tg-button);
      border: 1px solid var(--tg-button);
      border-radius: 18px;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 600;
      transition: background 0.15s, color 0.15s, border-color 0.15s;
    }

    .btn-mini.toggle.active {
      background: var(--tg-button);
      color: var(--tg-button-text);
      border-color: var(--tg-button);
    }

    .btn-mini.toggle:active {
      transform: scale(0.96);
    }

    .position {
      background: var(--tg-bg);
      border: 1px solid var(--tg-secondary-bg);
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 12px;
      position: relative;
    }

    .position-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .position-title {
      font-weight: 600;
      font-size: 13px;
    }

    .btn-delete {
      background: #ff4444;
      color: white;
      border: none;
      border-radius: 4px;
      width: 28px;
      height: 28px;
      cursor: pointer;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .btn-delete:active {
      opacity: 0.8;
    }

    .search-results {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--tg-bg);
      border: 1px solid var(--tg-secondary-bg);
      border-radius: 6px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 10;
      margin-top: 4px;
    }

    .search-results-item {
      padding: 10px 12px;
      border-bottom: 1px solid var(--tg-secondary-bg);
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
    }

    .search-results-item:last-child {
      border-bottom: none;
    }

    .search-results-item:active {
      background: var(--tg-secondary-bg);
    }

    .search-results-price {
      color: var(--tg-hint);
      font-weight: 600;
    }

    .position-search-wrapper {
      position: relative;
    }

    .summary {
      background: var(--tg-bg);
      border: 1px solid var(--tg-secondary-bg);
      border-radius: 6px;
      padding: 15px;
      margin-bottom: 20px;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      font-size: 13px;
    }

    .summary-row.total {
      font-size: 16px;
      font-weight: 600;
      padding-top: 8px;
      border-top: 1px solid var(--tg-secondary-bg);
      margin-top: 8px;
    }

    .summary-label {
      color: var(--tg-hint);
    }

    .summary-value {
      font-weight: 600;
    }

    .empty {
      text-align: center;
      color: var(--tg-hint);
      padding: 20px;
      font-size: 13px;
    }

    @media (max-width: 480px) {
      body {
        padding: 10px;
      }

      .section {
        padding: 12px;
      }

      .btn {
        padding: 10px 12px;
        font-size: 13px;
      }

      .logo img {
        max-width: 100px;
      }
    }

    .loader-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .loader-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .loader-text {
      color: white;
      margin-top: 15px;
      font-size: 14px;
      text-align: center;
    }

    .loader-overlay>div {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
  </style>
</head>

<body>
  <div id="app">
    <!-- –ó–∞–≥—Ä—É–∑–∫–∞ -->
    <div v-if="isLoading" class="loader-overlay">
      <div>
        <div class="loader-spinner"></div>
        <div class="loader-text">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤...</div>
      </div>



    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <div v-if="!isLoading">
      <!-- –õ–æ–≥–æ—Ç–∏–ø -->
      <div class="logo">
        <img src="./logo.svg" alt="–õ–æ–≥–æ—Ç–∏–ø">
      </div>

      <!-- –î–∞–Ω–Ω—ã–µ –ø–æ–∫—É–ø–∞—Ç–µ–ª—è -->
      <div class="section">
        <div class="section-title">–î–∞–Ω–Ω—ã–µ –ø–æ–∫—É–ø–∞—Ç–µ–ª—è</div>

        <div class="form-group">
          <label>–§–ò–û –ø–æ–∫—É–ø–∞—Ç–µ–ª—è</label>
          <input v-model="buyer.name" placeholder="–í–≤–µ–¥–∏—Ç–µ –§–ò–û" type="text">
        </div>

        <div class="form-group">
          <label>–ê–¥—Ä–µ—Å</label>
          <input v-model="buyer.address" placeholder="–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å" type="text">
        </div>

        <div class="form-group">
          <label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
          <input v-model="buyer.phone" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω" type="tel">
        </div>
      </div>

      <!-- –¢–∏–ø —Ü–µ–Ω—ã -->
      <div class="section">
        <div class="section-title">–¢–∏–ø —Ü–µ–Ω—ã</div>
        <div class="btn-group">
          <button class="btn" :class="{ active: priceType === 'retail' }" @click="priceType = 'retail'">
            üí∞ –†–æ–∑–Ω–∏—á–Ω–∞—è
          </button>
          <button class="btn" :class="{ active: priceType === 'wholesale' }" @click="priceType = 'wholesale'">
            üì¶ –û–ø—Ç–æ–≤–∞—è
          </button>
        </div>
      </div>


      <!-- –ü–æ–∑–∏—Ü–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤ -->
      <div class="section">
        <div class="section-title">–¢–æ–≤–∞—Ä—ã ({{ positions.length }})</div>

        <div v-for="(position, index) in positions" :key="position.id" class="position">
          <div class="position-header">
            <span class="position-title">–ü–æ–∑–∏—Ü–∏—è {{ index + 1 }}</span>
            <button class="btn-delete" @click="removePosition(index)">‚úï</button>
          </div>

          <div class="form-group position-search-wrapper">
            <label>–¢–æ–≤–∞—Ä</label>
            <input v-model="position.search" @input="searchProducts(index)" placeholder="–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–∞..." type="text"
              autocomplete="off">

            <div v-if="position.searchResults.length > 0" class="search-results">
              <div v-for="product in position.searchResults" :key="product.id" class="search-results-item"
                @click="selectProduct(index, product)">
                <span>{{ product.name }}</span>
                <span class="search-results-price">{{ getPriceByType(product) }} ‚ÇΩ</span>
              </div>
            </div>
          </div>

          <div v-if="position.product" class="form-group">
            <label>–í—ã–±—Ä–∞–Ω–Ω—ã–π —Ç–æ–≤–∞—Ä</label>
            <input v-model="position.product.name" disabled type="text">
          </div>

          <div class="form-group">
            <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
            <input v-model.number="position.qty" min="1" placeholder="1" type="number">
          </div>
          <div v-if="position.product" style="position:relative;
                   padding:8px;
                   background:var(--tg-secondary-bg);
                   border-radius:6px;
                   font-weight:600;
                   font-size:14px;
                   text-align:right;">


            <div class="btn-group">
              <button class="btn-mini"
                @click="position.purchaseDiscountPercent = Math.max(0, position.purchaseDiscountPercent - 1)">‚àí</button>


              <button class="btn-mini toggle" :class="{ active: position.purchaseDiscount }"
                @click="position.purchaseDiscount = !position.purchaseDiscount">
                üè∑Ô∏è ‚àí{{ position.purchaseDiscountPercent }}%
              </button>



              <button class="btn-mini"
                @click="position.purchaseDiscountPercent = Math.min(100, position.purchaseDiscountPercent + 1)">+</button>
            </div>

            –°—É–º–º–∞:
            {{ (getPriceByType(position.product) * position.qty).toFixed(2) }} ‚ÇΩ
          </div>

        </div>

        <button class="btn btn-primary" @click="addPosition">+ –î–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é</button>
      </div>

      <!-- –°–∫–∏–¥–∫–∞ –∏ –∞–≤–∞–Ω—Å -->
      <div v-if="positions.length > 0" class="section">
        <div class="form-group">
          <label>–°–∫–∏–¥–∫–∞ (‚ÇΩ)</label>
          <input v-model.number="discount" min="0" max="100" placeholder="0" type="number">
        </div>

        <div class="form-group">
          <label>–ê–≤–∞–Ω—Å (‚ÇΩ)</label>
          <input v-model.number="prepayment" min="0" placeholder="0" type="number">
        </div>
      </div>

      <!-- –ò—Ç–æ–≥–∏ -->
      <div v-if="positions.length > 0" class="summary">
        <div class="summary-row">
          <span class="summary-label">–°—É–º–º–∞ –±–µ–∑ —Å–∫–∏–¥–∫–∏:</span>
          <span class="summary-value">{{ sumNoDiscount.toFixed(2) }} ‚ÇΩ</span>
        </div>

        <div v-if="discountAmount > 0" class="summary-row">
          <span class="summary-label">–°–∫–∏–¥–∫–∞ ({{ discount }} ‚ÇΩ):</span>
          <span class="summary-value">{{ discountAmount.toFixed(2) }} ‚ÇΩ</span>
        </div>

        <div v-if="prepayment > 0" class="summary-row">
          <span class="summary-label">–ê–≤–∞–Ω—Å:</span>
          <span class="summary-value">{{ prepayment.toFixed(2) }} ‚ÇΩ</span>
        </div>

        <div class="summary-row total">
          <span>–ö –æ–ø–ª–∞—Ç–µ:</span>
          <span>{{ totalAmount.toFixed(2) }} ‚ÇΩ</span>
        </div>
      </div>

      <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
      <div class="section">
        <button v-if="positions.length > 0" class="btn btn-primary" @click="generateInvoice">
          üìÑ –°–æ–∑–¥–∞—Ç—å –Ω–∞–∫–ª–∞–¥–Ω—É—é
        </button>
        <div v-else class="empty">
          –î–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–∞–∫–ª–∞–¥–Ω–æ–π
        </div>
      </div>




    </div>




  </div>
  <script>
    const { createApp } = Vue;




    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è GET –ø–∞—Ä–∞–º–µ—Ç—Ä–∞
    function getUrlParam(param) {
      const params = new URLSearchParams(window.location.search);
      const encoded = params.get('start');

      try {
        const decoded = atob(encoded);
        return decoded
      } catch (e) { alert(e) }
    }

    createApp({
      data() {
        return {
          isLoading: true,
          products: [],
          apiUrl: getUrlParam(),
          cacheKey: 'products_cache',
          cacheTtl: 3600000, // 1 —á–∞—Å –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
          buyer: {
            name: '',
            address: '',
            phone: ''
          },
          positions: [],
          priceType: 'retail',
          discount: 0,
          prepayment: 0,
          nextPositionId: 1,
          tg: null
        };
      },

      computed: {
        sumNoDiscount() {
          return this.positions.reduce((sum, pos) => {
            if (pos.product) {
              return sum + (this.getPriceByType(pos.product) * pos.qty);
            }
            return sum;
          }, 0);
        },

        totalAmount() {
          return this.sumNoDiscount - this.discount;
        },

        sumPurchase() {
          const sum = this.positions.reduce((sum, pos) => {
            if (!pos.product) return sum;

            const k = 1 - pos.purchaseDiscountPercent / 100;
            return sum + pos.product.purchase * k * pos.qty;
          }, 0);

          if (this.purchaseDiscount) {
            return sum * 0.86
          }

          return sum
        },
      },

      mounted() {
        this.initApp();
      },

      methods: {
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫—ç—à–∞
        getCachedProducts() {
          try {
            const cached = localStorage.getItem(this.cacheKey);
            if (!cached) return null;

            const { data, timestamp } = JSON.parse(cached);
            const now = Date.now();

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å –∫—ç—à–∞
            if (now - timestamp > this.cacheTtl) {
              localStorage.removeItem(this.cacheKey);
              return null;
            }

            return data;
          } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ –∫—ç—à–∞:', e);
            return null;
          }
        },

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫—ç—à–∞
        setCachedProducts(data) {
          try {
            localStorage.setItem(this.cacheKey, JSON.stringify({
              data,
              timestamp: Date.now()
            }));
          } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∫—ç—à–∞:', e);
          }
        },

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º
        async loadCategories() {
          // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à
          const cached = this.getCachedProducts();
          if (cached) {
            console.log('–¢–æ–≤–∞—Ä—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ –∫—ç—à–∞');
            this.products = cached.map((item, i) => ({
              id: i,
              name: item.name,
              retail: item.retail,
              wholesale: item.wholesale,
              purchase: item.purchase
            }));
            return;
          }

          // –ï—Å–ª–∏ –∫—ç—à–∞ –Ω–µ—Ç, –∑–∞–≥—Ä—É–∂–∞–µ–º —Å —Å–µ—Ä–≤–µ—Ä–∞
          const res = await fetch(`${this.apiUrl}?type=categories`);
          const json = await res.json();

          // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à
          this.setCachedProducts(json);

          // –î–æ–±–∞–≤–ª—è–µ–º –≤ –º–∞—Å—Å–∏–≤ products
          this.products = json.map((item, i) => ({
            id: i,
            name: item.name,
            retail: item.retail,
            wholesale: item.wholesale,
            purchase: item.purchase
          }));
        },

        async initApp() {
          // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤ (—Å –∫—ç—à–µ–º)
          await this.loadCategories();

          // –°–∫—Ä—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑—á–∏–∫
          this.isLoading = false;

          if (window.Telegram && Telegram.WebApp) {
            this.tg = Telegram.WebApp;
            this.tg.ready();
            this.applyTheme();
            this.tg.onThemeChanged?.(() => {
              this.applyTheme();
            });
          }
          this.addPosition();
        },

        applyTheme() {
          const t = this.tg?.themeParams;
          if (!t) return;

          const root = document.documentElement;
          root.style.setProperty('--tg-bg', t.bg_color || '#ffffff');
          root.style.setProperty('--tg-text', t.text_color || '#000000');
          root.style.setProperty('--tg-hint', t.hint_color || '#999999');
          root.style.setProperty('--tg-button', t.button_color || '#0088cc');
          root.style.setProperty('--tg-button-text', t.button_text_color || '#ffffff');
          root.style.setProperty('--tg-secondary-bg', t.secondary_bg_color || '#f5f5f5');
        },

        addPosition() {
          this.positions.push({
            id: this.nextPositionId++,
            product: null,
            search: '',
            searchResults: [],
            qty: 1,
            purchaseDiscountPercent: 14,
          });
        },

        removePosition(index) {
          this.positions.splice(index, 1);
        },

        searchProducts(index) {
          const query = this.positions[index].search.toLowerCase();
          if (query.length === 0) {
            this.positions[index].searchResults = [];
            return;
          }
          this.positions[index].searchResults = this.products.filter(p =>
            p.name.toLowerCase().includes(query)
          );
        },

        selectProduct(index, product) {
          this.positions[index].product = product;
          this.positions[index].search = '';
          this.positions[index].searchResults = [];
        },

        getPriceByType(product) {
          return product[this.priceType];
        },

        generateInvoice() {
          const invoiceData = {
            number: Math.floor(Math.random() * 10000),
            date: new Date().toLocaleDateString('ru-RU'),
            client: {
              name: this.buyer.name || '–ü–æ–∫—É–ø–∞—Ç–µ–ª—å',
              address: this.buyer.address || '–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω',
              phone: this.buyer.phone || '–ù–æ–º–µ—Ä –Ω–µ —É–∫–∞–∑–∞–Ω'
            },
            items: this.positions
              .filter(p => p.product)
              .map(p => ({
                name: p.product.name,
                qty: p.qty,
                price: this.getPriceByType(p.product)
              })),
            sumPurchase: this.sumPurchase,
            sumNoDiscount: this.sumNoDiscount,
            discountSum: +this.discount,
            total: this.totalAmount,
            prepayment: this.prepayment
          }


          console.log(invoiceData)



          if (this.tg?.sendData) {
            this.tg.sendData(JSON.stringify(invoiceData));
          }
        }
      }
    }).mount('#app');
  </script>
</body>

</html>
